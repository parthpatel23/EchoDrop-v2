<!-- AngularApp\EchoDrop-v2\frontend-angular\src\app\admin\admin-dashboard\admin-dashboard.component.html -->
<div class="admin-container">
  <div class="admin-header">
    <div *ngIf="auth.isOwner || auth.isAdmin">
      <h1 *ngIf="auth.isOwner">Owner Console</h1>
      <h1 *ngIf="!auth.isOwner && auth.isAdmin">Admin Console</h1>
      <p>Monitor users, messages, and delivery health for EchoDrop.</p>
    </div>
    <div class="admin-badge" *ngIf="auth.isOwner || auth.isAdmin">
      <span *ngIf="auth.isOwner" class="badge badge--owner">Owner</span>
      <span *ngIf="!auth.isOwner && auth.isAdmin" class="badge badge--admin">Admin</span>
    </div>
  </div>

  <!-- Error state -->
  <div *ngIf="error" class="admin-error">
    <i class="fas fa-exclamation-triangle"></i>
    <div>
      <h3>Access issue</h3>
      <p>{{ error }}</p>
    </div>
  </div>

  <!-- Loading state -->
  <div *ngIf="loading && !error" class="admin-loading">
    <div class="spinner"></div>
    <p>Loading admin data…</p>
  </div>

  <!-- Stats cards -->
  <div *ngIf="!loading && !error && stats" class="admin-grid">
    <div class="card">
      <h3>Total Users</h3>
      <p class="metric">{{ stats.totalUsers }}</p>
      <p class="card-subtitle">All registered accounts</p>
    </div>

    <div class="card">
      <h3>Total Messages</h3>
      <p class="metric">{{ stats.totalMessages }}</p>
      <p class="card-subtitle">All scheduled messages</p>
    </div>

    <div class="card card--status pending" edTooltip="Pending: queued and waiting to be processed."
      edTooltipPosition="top">
      <h3>Pending</h3>
      <p class="metric">{{ stats.byStatus?.pending }}</p>
    </div>

    <div class="card card--status sent" edTooltip="Sent: delivered successfully." edTooltipPosition="top">
      <h3>Sent</h3>
      <p class="metric">{{ stats.byStatus?.sent }}</p>
    </div>

    <div class="card card--status failed" edTooltip="Failed: delivery attempt failed (provider/network/auth/etc)."
      edTooltipPosition="top">
      <h3>Failed</h3>
      <p class="metric">{{ stats.byStatus?.failed }}</p>
    </div>

    <div class="card card--status cancelled" edTooltip="Cancelled: cancelled before sending." edTooltipPosition="top">
      <h3>Cancelled</h3>
      <p class="metric">{{ stats.byStatus?.cancelled }}</p>
    </div>
  </div>

  <!-- Failed messages table -->
  <div *ngIf="!error" class="admin-section">
    <div class="admin-section__header">
      <h2>Recent Failed Messages</h2>
      <span class="admin-section__badge">
        {{ failedMessages.length }} shown
      </span>
    </div>

    <div *ngIf="failedMessages.length > 0" class="table-wrapper">
      <table class="admin-table">
        <thead>
          <tr>
            <th>User</th>
            <th>Recipient</th>
            <th>Platform</th>
            <th>Content</th>
            <th>Scheduled</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let msg of failedMessages">
            <td>{{ msg.createdBy?.email || '—' }}</td>
            <td>{{ msg.recipient || '—' }}</td>
            <td [edTooltip]="platformTooltip(msg.platform)" edTooltipPosition="top">
              {{ msg.platform | titlecase }}
            </td>
            <td class="truncate" [title]="msg.content">{{ msg.content }}</td>
            <td>{{ msg.scheduledTime | date: 'short' }}</td>
            <td>
              <span class="status-chip status-chip--failed">Failed</span>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <p *ngIf="!loading && failedMessages.length === 0 && !error" class="empty-hint">
      No failed messages. Everything looks healthy.
    </p>
  </div>

  <!-- Users table -->
  <div *ngIf="!error" class="admin-section">
    <div class="admin-section__header">
      <h2>Users</h2>
      <span class="admin-section__badge">
        {{ userTotal }} total
      </span>
    </div>

    <!-- Filters row -->
    <div class="users-filters">
      <input type="text" name="userSearch" autocomplete="off" placeholder="Search by email or name"
        [(ngModel)]="userSearch" (input)="onUserSearchInput()" />

      <select [(ngModel)]="userHasMessages" (ngModelChange)="onHasMessagesChange($event)">
        <option value="all">All users</option>
        <option value="true">Has messages</option>
        <option value="false">No messages</option>
      </select>
    </div>

    <div *ngIf="users.length > 0" class="table-wrapper">
      <table class="admin-table">
        <thead>
          <tr>
            <th>Email</th>
            <th>Name</th>
            <th>Role</th>
            <th>Messages</th>
            <th>Joined</th>
            <th *ngIf="isOwner">Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let u of users">
            <td>{{ u.email }}</td>
            <td>{{ u.name || '—' }}</td>
            <td>
              <span class="role-chip" [ngClass]="{
                'role-chip--owner': u.isOwner,
                'role-chip--admin': !u.isOwner && u.isAdmin,
                'role-chip--user': !u.isOwner && !u.isAdmin
              }">
                {{ u.isOwner ? 'Owner' : (u.isAdmin ? 'Admin' : 'User') }}
              </span>
            </td>
            <td>{{ u.messagesCount }}</td>
            <td>{{ u.joinedAt | date: 'shortDate' }}</td>
            <td *ngIf="isOwner">
              <!-- Don't show button for yourself or for the owner account -->
              <button *ngIf="u.email !== currentAdminEmail && !u.isOwner" type="button" class="btn-role"
                [ngClass]="u.isAdmin ? 'btn-role--remove' : 'btn-role--make'" (click)="openRoleConfirm(u)">
                {{ u.isAdmin ? 'Remove admin' : 'Make admin' }}
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- ===== ADMIN ROLE CONFIRM MODAL ===== -->
    <div *ngIf="showRoleConfirm" class="admin-modal-overlay">
      <div class="admin-modal">
        <div class="admin-modal__header">
          <h3>Change Admin Role</h3>
          <button type="button" class="admin-modal__close" (click)="closeRoleConfirm()">
            ×
          </button>
        </div>
        <div class="admin-modal__body" *ngIf="roleTarget">
          <p>
            Are you sure you want to
            <strong>{{ roleTargetNewState ? 'make' : 'remove' }}</strong>
            admin access for <strong>{{ roleTarget.email }}</strong>?
          </p>
        </div>
        <div class="admin-modal__footer">
          <button type="button" class="btn btn-secondary" (click)="closeRoleConfirm()">
            Cancel
          </button>
          <button type="button" class="btn btn-primary" (click)="confirmRoleChange()">
            Yes, change role
          </button>
        </div>
      </div>
    </div>

    <!-- Empty state for filtered users -->
    <p *ngIf="!loading && users.length === 0 && !error" class="empty-hint">
      No users match your filters.
    </p>
  </div>

  <!-- Pagination controls -->
  <div *ngIf="userTotalPages > 1" class="users-pagination">
    <button type="button" (click)="goToUserPage(userPage - 1)" [disabled]="userPage === 1">
      ‹ Prev
    </button>
    <span>Page {{ userPage }} of {{ userTotalPages }}</span>
    <button type="button" (click)="goToUserPage(userPage + 1)" [disabled]="userPage === userTotalPages">
      Next ›
    </button>
  </div>

</div>